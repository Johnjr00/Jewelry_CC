<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Jewelry Case Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.08);
      --panel2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.78);
      --radius: 18px;
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #7f1d1d 0%, #1a0b0b 55%, #070308 100%);
      color: var(--text);
    }

    .glass{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .glass-soft{
      background: var(--panel2);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .btn, .form-control, .form-select, .alert { border-radius: 16px; }
    .form-control, .form-select, textarea{ background: rgba(255,255,255,.92); color:#111; border-color: rgba(0,0,0,.08);} 
    .form-control::placeholder{ color: rgba(0,0,0,.45); }
    .form-control:focus, .form-select:focus, textarea:focus{
      background: rgba(255,255,255,.98);
      color: #111;
    }
    .form-control:disabled, .form-select:disabled, textarea:disabled,
    .form-control[readonly], textarea[readonly]{
      background: rgba(255,255,255,.85);
      color: #111;
      opacity: 1;
    }
    .form-control, .form-select { padding: .9rem .95rem; }
    .btn { padding: .8rem 1rem; font-weight: 600; }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(7,11,20,.75);
      border-bottom: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.35rem .6rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: .85rem;
      white-space: nowrap;
    }

    .case-tile{
      min-height: 116px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      transition: transform .08s ease, background .08s ease;
      text-decoration: none;
      color: var(--text);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 14px 14px 12px 14px;
    }
    .case-tile:hover{ transform: translateY(-1px); background: rgba(255,255,255,.085); color: var(--text); }
    .case-code{ font-size: 1.35rem; font-weight: 800; letter-spacing: .02em; }
    .case-name{ color: var(--muted); font-size: .95rem; }
    .case-meta{ color: rgba(255,255,255,.72); font-size: .86rem; display:flex; gap:.5rem; flex-wrap: wrap; }

    .divider{ border-top: 1px solid rgba(255,255,255,.12); }

    /* Strong, consistent contrast for tables on dark glass backgrounds */
    .table{
      color: var(--text);
      --bs-table-color: var(--text);
      --bs-table-bg: transparent;
      --bs-table-border-color: rgba(255,255,255,.12);
      --bs-table-striped-bg: rgba(255,255,255,.03);
      --bs-table-striped-color: var(--text);
      --bs-table-hover-bg: rgba(255,255,255,.06);
      --bs-table-hover-color: var(--text);
    }
    .table thead th{
      color: rgba(255,255,255,.78);
      font-weight: 700;
      border-color: rgba(255,255,255,.14);
    }
    .table tbody td{
      border-color: rgba(255,255,255,.12);
      color: var(--text);
    }
    .table-hover tbody tr:hover{
      background: rgba(255,255,255,.06);
    }

    /* Bootstrap's text-white-50 can get too faint on tablets; bump it slightly */
    .text-white-50{ color: rgba(255,255,255,.78) !important; }

    /* Links: keep them readable on the dark red background */
    a{ color: rgba(255,255,255,.90); }
    a:hover{ color: #fff; }

    /* Dropdowns/menus if any future pages add them */
    .dropdown-menu{
      background: rgba(15,15,20,.95);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
    }
    .dropdown-item{ color: var(--text); }
    .dropdown-item:hover, .dropdown-item:focus{
      background: rgba(255,255,255,.08);
      color: #fff;
    }

    @media (min-width: 992px){
      .sticky-actions{ position: sticky; top: 92px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="container-fluid px-3 py-3 d-flex align-items-center justify-content-between">
      <a class="text-decoration-none text-white fw-bold fs-5" href="{{ url_for('index') }}">Jewelry Inventory</a>

      {% if user %}
      <div class="d-flex align-items-center gap-2">
        <span class="chip d-none d-md-inline">ðŸ‘¤ {{ user.username }} Â· {{ user.role }}</span>
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('index') }}">Home</a>
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('logout') }}">Logout</a>
      </div>
      {% endif %}
    </div>

    {% if user %}
    <div class="container-fluid px-3 pb-3">
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-outline-light" href="{{ url_for('index') }}">Home</a>
        <a class="btn btn-outline-light" href="{{ url_for('counts') }}">Counts</a>
        <a class="btn btn-light" href="{{ url_for('receive') }}">Receive</a>
        <a class="btn btn-light" href="{{ url_for('move') }}">Move</a>
        <a class="btn btn-warning" href="{{ url_for('sell') }}">Sell</a>
        <a class="btn btn-danger" href="{{ url_for('missing') }}">Missing</a>
        <a class="btn btn-outline-light" href="{{ url_for('history') }}">History</a>
        <a class="btn btn-outline-light" href="{{ url_for('export_inventory') }}">Export Inventory CSV</a>
          <a class="btn btn-outline-light" href="{{ url_for('daily_activity_reports') }}">Daily Reports</a>
        {% if user.role == 'admin' %}
          <a class="btn btn-outline-light" href="{{ url_for('users') }}">Users</a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <div class="container-fluid px-3 py-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} glass-soft border-0 text-white" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </div>

  <div class="modal fade" id="upcScannerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content glass border-0">
        <div class="modal-header border-0">
          <h5 class="modal-title">Scan UPC</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="ratio ratio-16x9 glass-soft overflow-hidden">
            <video id="upcScannerVideo" autoplay muted playsinline></video>
          </div>
          <div class="text-white-50 mt-3" data-role="status"></div>
          <div class="text-white-50 mt-1 d-none" data-role="support">
            Barcode scanning needs a browser with BarcodeDetector support (Safari 16+ recommended).
          </div>
          <div class="mt-3 d-none" data-role="capture">
            <button class="btn btn-outline-light" type="button" data-role="capture-btn">Capture Photo</button>
            <input class="visually-hidden" data-role="capture-input" type="file" accept="image/*" capture="environment">
            <div class="text-white-50 mt-2">
              If the live camera preview is unavailable, take a photo of the barcode instead.
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-outline-light" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    window.addEventListener("load", () => {
      const el = document.querySelector("[data-autofocus='true']");
      if (el) el.focus();
    });

    window.addEventListener("load", () => {
      const scanButtons = document.querySelectorAll("[data-upc-scan-target]");
      if (!scanButtons.length) return;

      const modalEl = document.getElementById("upcScannerModal");
      const videoEl = document.getElementById("upcScannerVideo");
      const statusEl = modalEl.querySelector("[data-role='status']");
      const supportEl = modalEl.querySelector("[data-role='support']");
      const captureEl = modalEl.querySelector("[data-role='capture']");
      const captureBtn = modalEl.querySelector("[data-role='capture-btn']");
      const captureInput = modalEl.querySelector("[data-role='capture-input']");
      const modal = new bootstrap.Modal(modalEl);
      let activeInput = null;
      let activeStream = null;
      let scanning = false;
      let detector = null;
      let rafId = null;

      const formats = ["upc_a", "upc_e", "ean_13", "ean_8"];

      const stopStream = () => {
        if (activeStream) {
          activeStream.getTracks().forEach((track) => track.stop());
          activeStream = null;
        }
        if (videoEl) {
          videoEl.srcObject = null;
        }
      };

      const appendValue = (value) => {
        if (!activeInput) return;
        if (activeInput.tagName === "TEXTAREA") {
          const current = activeInput.value || "";
          const next = current.trim() ? `${current.replace(/\s*$/, "")}\n${value}` : value;
          activeInput.value = next;
        } else {
          activeInput.value = value;
        }
        activeInput.dispatchEvent(new Event("input", { bubbles: true }));
        activeInput.focus();
      };

      const ensureDetector = () => {
        if (!("BarcodeDetector" in window)) {
          return null;
        }
        if (!detector) {
          detector = new BarcodeDetector({ formats });
        }
        return detector;
      };

      const showCaptureFallback = (message) => {
        statusEl.textContent = message;
        captureEl.classList.remove("d-none");
        supportEl.classList.add("d-none");
      };

      const loadImageElement = (file) =>
        new Promise((resolve, reject) => {
          const img = new Image();
          const url = URL.createObjectURL(file);
          img.onload = () => {
            URL.revokeObjectURL(url);
            resolve(img);
          };
          img.onerror = () => {
            URL.revokeObjectURL(url);
            reject(new Error("Image load failed."));
          };
          img.src = url;
        });

      const loadZxing = (() => {
        let promise = null;
        return () => {
          if (window.ZXing) {
            return Promise.resolve(window.ZXing);
          }
          if (promise) {
            return promise;
          }
          promise = new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src = "https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js";
            script.async = true;
            script.onload = () => resolve(window.ZXing);
            script.onerror = () => reject(new Error("ZXing load failed."));
            document.head.appendChild(script);
          });
          return promise;
        };
      })();

      const decodeWithZxing = async (file) => {
        const ZXing = await loadZxing();
        if (!ZXing) {
          return [];
        }
        const img = await loadImageElement(file);
        const hints = new Map();
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
          ZXing.BarcodeFormat.UPC_A,
          ZXing.BarcodeFormat.UPC_E,
          ZXing.BarcodeFormat.EAN_13,
          ZXing.BarcodeFormat.EAN_8,
        ]);
        const reader = new ZXing.BrowserMultiFormatReader(hints, 200);
        try {
          const result = await reader.decodeFromImageElement(img);
          return result ? [{ rawValue: result.text }] : [];
        } catch (error) {
          return [];
        } finally {
          if (reader && typeof reader.reset === "function") {
            reader.reset();
          }
        }
      };

      const detectFromFile = async (file, activeDetector) => {
        let source = null;
        if ("createImageBitmap" in window) {
          try {
            source = await createImageBitmap(file);
          } catch (error) {
            source = null;
          }
        }
        if (!source) {
          source = await loadImageElement(file);
        }
        let barcodes = await activeDetector.detect(source);
        if ((!barcodes || !barcodes.length) && source instanceof HTMLImageElement) {
          const canvas = document.createElement("canvas");
          canvas.width = source.naturalWidth || source.width;
          canvas.height = source.naturalHeight || source.height;
          const ctx = canvas.getContext("2d");
          if (ctx) {
            ctx.drawImage(source, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            barcodes = await activeDetector.detect(imageData);
          }
        }
        return barcodes;
      };

      const scanLoop = () => {
        if (!scanning || !detector) return;
        detector
          .detect(videoEl)
          .then((barcodes) => {
            if (barcodes && barcodes.length) {
              appendValue(barcodes[0].rawValue);
              statusEl.textContent = `Captured ${barcodes[0].rawValue}`;
              scanning = false;
              modal.hide();
            }
          })
          .catch(() => {})
          .finally(() => {
            if (scanning) {
              rafId = requestAnimationFrame(scanLoop);
            }
          });
      };

      const startScan = async () => {
        statusEl.textContent = "Starting cameraâ€¦";
        supportEl.classList.add("d-none");
        captureEl.classList.add("d-none");
        if (!window.isSecureContext) {
          showCaptureFallback("Live camera access requires HTTPS. Use photo capture instead.");
          return;
        }
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showCaptureFallback("Live camera access is not available in this browser.");
          return;
        }
        try {
          activeStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } },
          audio: false,
        });
          videoEl.srcObject = activeStream;
          await videoEl.play();
        } catch (err) {
          showCaptureFallback("Camera access was blocked. Use photo capture instead.");
          return;
        }
        if (!ensureDetector()) {
          stopStream();
          statusEl.textContent = "Live scanning is unavailable. Use photo capture instead.";
          captureEl.classList.remove("d-none");
          supportEl.classList.remove("d-none");
          return;
        }
        scanning = true;
        statusEl.textContent = "Point the camera at the UPC barcode.";
        scanLoop();
      };

      captureBtn.addEventListener("click", () => {
        captureInput.value = "";
        captureInput.click();
      });

      captureInput.addEventListener("change", async (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        statusEl.textContent = "Scanning photoâ€¦";
        try {
          const activeDetector = ensureDetector();
          let barcodes = [];
          if (activeDetector) {
            barcodes = await detectFromFile(file, activeDetector);
          }
          if (!barcodes || !barcodes.length) {
            barcodes = await decodeWithZxing(file);
          }
          if (barcodes && barcodes.length) {
            appendValue(barcodes[0].rawValue);
            statusEl.textContent = `Captured ${barcodes[0].rawValue}`;
            modal.hide();
          } else {
            statusEl.textContent = "No barcode detected in the photo. Try again.";
            supportEl.classList.remove("d-none");
          }
        } catch (error) {
          statusEl.textContent = "Could not read the photo. Try again.";
          supportEl.classList.remove("d-none");
        }
      });

      modalEl.addEventListener("hidden.bs.modal", () => {
        scanning = false;
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        stopStream();
        statusEl.textContent = "";
        captureInput.value = "";
      });

      scanButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetId = btn.getAttribute("data-upc-scan-target");
          const target = document.getElementById(targetId);
          if (!target) return;
          activeInput = target;
          modal.show();
          startScan();
        });
      });
    });
  </script>
</body>
</html>
