<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Jewelry Case Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.08);
      --panel2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.78);
      --radius: 18px;
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #7f1d1d 0%, #1a0b0b 55%, #070308 100%);
      color: var(--text);
    }

    .glass{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .glass-soft{
      background: var(--panel2);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .btn, .form-control, .form-select, .alert { border-radius: 16px; }
    .form-control, .form-select, textarea{ background: rgba(255,255,255,.92); color:#111; border-color: rgba(0,0,0,.08);} 
    .form-control::placeholder{ color: rgba(0,0,0,.45); }
    .form-control:focus, .form-select:focus, textarea:focus{
      background: rgba(255,255,255,.98);
      color: #111;
    }
    .form-control:disabled, .form-select:disabled, textarea:disabled,
    .form-control[readonly], textarea[readonly]{
      background: rgba(255,255,255,.85);
      color: #111;
      opacity: 1;
    }
    .form-control, .form-select { padding: .9rem .95rem; }
    .btn { padding: .8rem 1rem; font-weight: 600; }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(7,11,20,.75);
      border-bottom: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.35rem .6rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: .85rem;
      white-space: nowrap;
    }

    .case-tile{
      min-height: 116px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      transition: transform .08s ease, background .08s ease;
      text-decoration: none;
      color: var(--text);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 14px 14px 12px 14px;
    }
    .case-tile:hover{ transform: translateY(-1px); background: rgba(255,255,255,.085); color: var(--text); }
    .case-code{ font-size: 1.35rem; font-weight: 800; letter-spacing: .02em; }
    .case-name{ color: var(--muted); font-size: .95rem; }
    .case-meta{ color: rgba(255,255,255,.72); font-size: .86rem; display:flex; gap:.5rem; flex-wrap: wrap; }

    .divider{ border-top: 1px solid rgba(255,255,255,.12); }

    /* Strong, consistent contrast for tables on dark glass backgrounds */
    .table{
      color: var(--text);
      --bs-table-color: var(--text);
      --bs-table-bg: transparent;
      --bs-table-border-color: rgba(255,255,255,.12);
      --bs-table-striped-bg: rgba(255,255,255,.03);
      --bs-table-striped-color: var(--text);
      --bs-table-hover-bg: rgba(255,255,255,.06);
      --bs-table-hover-color: var(--text);
    }
    .table thead th{
      color: rgba(255,255,255,.78);
      font-weight: 700;
      border-color: rgba(255,255,255,.14);
    }
    .table tbody td{
      border-color: rgba(255,255,255,.12);
      color: var(--text);
    }
    .table-hover tbody tr:hover{
      background: rgba(255,255,255,.06);
    }

    /* Bootstrap's text-white-50 can get too faint on tablets; bump it slightly */
    .text-white-50{ color: rgba(255,255,255,.78) !important; }

    /* Links: keep them readable on the dark red background */
    a{ color: rgba(255,255,255,.90); }
    a:hover{ color: #fff; }

    /* Dropdowns/menus if any future pages add them */
    .dropdown-menu{
      background: rgba(15,15,20,.95);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
    }
    .dropdown-item{ color: var(--text); }
    .dropdown-item:hover, .dropdown-item:focus{
      background: rgba(255,255,255,.08);
      color: #fff;
    }

    @media (min-width: 992px){
      .sticky-actions{ position: sticky; top: 92px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="container-fluid px-3 py-3 d-flex align-items-center justify-content-between">
      <a class="text-decoration-none text-white fw-bold fs-5" href="{{ url_for('index') }}">Jewelry Inventory</a>

      {% if user %}
      <div class="d-flex align-items-center gap-2">
        <span class="chip d-none d-md-inline">ðŸ‘¤ {{ user.username }} Â· {{ user.role }}</span>
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('index') }}">Home</a>
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('logout') }}">Logout</a>
      </div>
      {% endif %}
    </div>

    {% if user %}
    <div class="container-fluid px-3 pb-3">
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-outline-light" href="{{ url_for('index') }}">Home</a>
        <a class="btn btn-outline-light" href="{{ url_for('counts') }}">Counts</a>
        <a class="btn btn-light" href="{{ url_for('receive') }}">Receive</a>
        <a class="btn btn-light" href="{{ url_for('move') }}">Move</a>
        <a class="btn btn-warning" href="{{ url_for('sell') }}">Sell</a>
        <a class="btn btn-danger" href="{{ url_for('missing') }}">Missing</a>
        <a class="btn btn-outline-light" href="{{ url_for('history') }}">History</a>
        <a class="btn btn-outline-light" href="{{ url_for('export_inventory') }}">Export Inventory CSV</a>
          <a class="btn btn-outline-light" href="{{ url_for('daily_activity_reports') }}">Daily Reports</a>
        {% if user.role == 'admin' %}
          <a class="btn btn-outline-light" href="{{ url_for('users') }}">Users</a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <div class="container-fluid px-3 py-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} glass-soft border-0 text-white" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </div>

  <div class="modal fade" id="upcScannerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content glass border-0">
        <div class="modal-header border-0">
          <h5 class="modal-title">Scan UPC</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="ratio ratio-16x9 glass-soft overflow-hidden">
            <video id="upcScannerVideo" autoplay muted playsinline></video>
          </div>
          <div class="text-white-50 mt-3" data-role="status"></div>
          <div class="text-white-50 mt-1 d-none" data-role="support">
            Barcode scanning needs a browser with BarcodeDetector support (Safari 16+ recommended).
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-outline-light" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    window.addEventListener("load", () => {
      const el = document.querySelector("[data-autofocus='true']");
      if (el) el.focus();
    });

    window.addEventListener("load", () => {
      const scanButtons = document.querySelectorAll("[data-upc-scan-target]");
      if (!scanButtons.length) return;

      const modalEl = document.getElementById("upcScannerModal");
      const videoEl = document.getElementById("upcScannerVideo");
      const statusEl = modalEl.querySelector("[data-role='status']");
      const supportEl = modalEl.querySelector("[data-role='support']");
      const modal = new bootstrap.Modal(modalEl);
      let activeInput = null;
      let activeStream = null;
      let scanning = false;
      let detector = null;
      let rafId = null;

      const formats = ["upc_a", "upc_e", "ean_13", "ean_8"];

      const stopStream = () => {
        if (activeStream) {
          activeStream.getTracks().forEach((track) => track.stop());
          activeStream = null;
        }
        if (videoEl) {
          videoEl.srcObject = null;
        }
      };

      const appendValue = (value) => {
        if (!activeInput) return;
        if (activeInput.tagName === "TEXTAREA") {
          const current = activeInput.value || "";
          const next = current.trim() ? `${current.replace(/\s*$/, "")}\n${value}` : value;
          activeInput.value = next;
        } else {
          activeInput.value = value;
        }
        activeInput.dispatchEvent(new Event("input", { bubbles: true }));
        activeInput.focus();
      };

      const scanLoop = () => {
        if (!scanning || !detector) return;
        detector
          .detect(videoEl)
          .then((barcodes) => {
            if (barcodes && barcodes.length) {
              appendValue(barcodes[0].rawValue);
              statusEl.textContent = `Captured ${barcodes[0].rawValue}`;
              scanning = false;
              modal.hide();
            }
          })
          .catch(() => {})
          .finally(() => {
            if (scanning) {
              rafId = requestAnimationFrame(scanLoop);
            }
          });
      };

      const startScan = async () => {
        statusEl.textContent = "Starting cameraâ€¦";
        if (!("BarcodeDetector" in window)) {
          statusEl.textContent = "Barcode scanning is not supported on this browser.";
          supportEl.classList.remove("d-none");
          return;
        }
        supportEl.classList.add("d-none");
        try {
          activeStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } },
            audio: false,
          });
          videoEl.srcObject = activeStream;
          await videoEl.play();
          if (!detector) {
            detector = new BarcodeDetector({ formats });
          }
          scanning = true;
          statusEl.textContent = "Point the camera at the UPC barcode.";
          scanLoop();
        } catch (err) {
          statusEl.textContent = "Camera access was blocked. Check permissions.";
        }
      };

      modalEl.addEventListener("hidden.bs.modal", () => {
        scanning = false;
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        stopStream();
        statusEl.textContent = "";
      });

      scanButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetId = btn.getAttribute("data-upc-scan-target");
          const target = document.getElementById(targetId);
          if (!target) return;
          activeInput = target;
          modal.show();
          startScan();
        });
      });
    });
  </script>
</body>
</html>
