{% extends "base.html" %}
{% block content %}

<div class="glass p-3 p-md-4" style="max-width: 980px;">
  <div class="d-flex flex-wrap align-items-start justify-content-between gap-2">
    <div>
      <div class="fw-bold fs-4">Count — Case {{ case.case_code }}</div>
      <div class="text-white-50">{{ case.case_name }}</div>
      <div class="mt-2">
        <span class="chip">Date: <strong class="text-white">{{ today }}</strong></span>
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-light" href="{{ url_for('counts') }}">Back to Counts</a>
      <a class="btn btn-outline-light" href="{{ url_for('view_case', case_code=case.case_code) }}">Case Page</a>
    </div>
  </div>

  <div class="divider my-3"></div>

  <div class="glass-soft p-3 p-md-4 mb-3">
    <div class="fw-bold fs-5 mb-2">System (live) totals</div>
    <div class="d-flex flex-wrap gap-2">
      {% for cat in count_categories %}
        <span class="chip">{{ cat.plural }}: <strong class="text-white">{{ sys[cat.count_key] }}</strong></span>
      {% endfor %}
      <span class="chip">Total: <strong class="text-white">{{ sys.total }}</strong></span>
      {% if sys.unknown and sys.unknown > 0 %}
        <span class="chip">Unknown type: <strong class="text-white">{{ sys.unknown }}</strong></span>
      {% endif %}
    </div>

    {% if last_count %}
      <div class="text-white-50 small mt-3">
        Latest physical count today: Total <span class="mono text-white">{{ last_count.total }}</span>
        {% if last_count.username %} — {{ last_count.username }}{% endif %}
        {% if last_count.total != sys.total %}
          <span class="ms-2 chip">Δ <strong class="text-white">{{ last_count.total - sys.total }}</strong></span>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <form method="post" class="glass-soft p-3 p-md-4 d-grid gap-3">
    <div class="fw-bold fs-5">Enter physical count</div>

    <div class="row g-3">
      {% for cat in count_categories %}
        <div class="col-6 col-md-3">
          <label class="form-label text-white-50">{{ cat.plural }}</label>
          <input class="form-control" type="number" min="0" name="{{ cat.count_key }}" id="{{ cat.count_key }}" value="0" required>
        </div>
      {% endfor %}
    </div>

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div class="chip">Total: <strong class="text-white" id="totalOut">0</strong></div>
      <div class="text-white-50 small">
        Total auto-calculates ({% for cat in count_categories %}{{ cat.plural }}{% if not loop.last %} + {% endif %}{% endfor %}).
      </div>
    </div>

    <div>
      <label class="form-label text-white-50">Notes (optional)</label>
      <input class="form-control" name="notes" placeholder="e.g., discrepancy notes / audit comments">
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-success">Save Count</button>
      <a class="btn btn-outline-light" href="{{ url_for('counts') }}">Cancel</a>
    </div>
  </form>
</div>

<script>
  const ids = [{% for cat in count_categories %}"{{ cat.count_key }}"{% if not loop.last %}, {% endif %}{% endfor %}];
  function calc(){
    let t = 0;
    for (const id of ids) t += parseInt(document.getElementById(id).value || "0", 10);
    document.getElementById("totalOut").textContent = String(t);
  }
  for (const id of ids) document.getElementById(id).addEventListener("input", calc);
  calc();
</script>

{% endblock %}
