{% extends "base.html" %}
{% block content %}

<div class="glass p-3 p-md-4">
  <div class="d-flex flex-wrap align-items-start justify-content-between gap-2">
    <div>
      <div class="d-flex gap-2 align-items-center">
        <div class="fw-bold fs-4">Case {{ case.case_code }}</div>
        {% if case.is_virtual %}<span class="chip">Virtual</span>{% endif %}
      </div>
      <div class="text-white-50">{{ case.case_name }}</div>
      <div class="row g-2 mt-3">
        <div class="col-12 col-md-4">
          <div class="glass-soft p-3 h-100">
            <div class="fw-bold text-uppercase small text-white-50 mb-2">Case</div>
            <div class="d-grid gap-1">
              {% for cat in count_categories %}
                <div class="d-flex justify-content-between">
                  <span>{{ cat.plural }}</span>
                  <span class="fw-bold">{{ case_type_totals[cat.count_key] }}</span>
                </div>
              {% endfor %}
              <div class="d-flex justify-content-between border-top pt-1 mt-1">
                <span>Total</span>
                <span class="fw-bold">{{ case_totals.total_qty }}</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="glass-soft p-3 h-100">
            <div class="fw-bold text-uppercase small text-white-50 mb-2">Reserve</div>
            <div class="d-grid gap-1">
              {% for cat in count_categories %}
                <div class="d-flex justify-content-between">
                  <span>{{ cat.plural }}</span>
                  <span class="fw-bold">{{ reserve_type_totals[cat.count_key] }}</span>
                </div>
              {% endfor %}
              <div class="d-flex justify-content-between border-top pt-1 mt-1">
                <span>Total</span>
                <span class="fw-bold">{{ reserve_totals.total_qty }}</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="glass-soft p-3 h-100">
            <div class="fw-bold text-uppercase small text-white-50 mb-2">Total</div>
            <div class="d-grid gap-1">
              {% for cat in count_categories %}
                <div class="d-flex justify-content-between">
                  <span>{{ cat.plural }}</span>
                  <span class="fw-bold">{{ combined_type_totals[cat.count_key] }}</span>
                </div>
              {% endfor %}
              <div class="d-flex justify-content-between border-top pt-1 mt-1">
                <span>Total</span>
                <span class="fw-bold">{{ totals.total_qty }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-2">
        <a class="chip text-decoration-none" href="{{ url_for('export_case', case_code=case.case_code) }}">Export Case CSV</a>
      </div>
      {% if last_count %}
        <div class="mt-2 text-white-50 small">
          Today\'s physical count ({{ last_count.local_date|mmddyyyy }}):
          Case {% for cat in count_categories %}
            {{ cat.plural }} <span class="mono">{{ last_count[cat.count_key] }}</span>{% if not loop.last %},{% endif %}
          {% endfor %};
          Reserve {% for cat in count_categories %}
            {{ cat.plural }} <span class="mono">{{ last_count["reserve_" ~ cat.count_key] }}</span>{% if not loop.last %},{% endif %}
          {% endfor %};
          Grand Total <span class="mono">{{ last_count.total }}</span>
          {% if last_count.username %} — by {{ last_count.username }}{% endif %}
        </div>
      {% endif %}
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-light" href="{{ url_for('index') }}">Back to Case Grid</a>

      {% if user.role == 'admin' %}
        <a class="btn btn-outline-light" href="{{ url_for('edit_case', case_code=case.case_code) }}">Edit Case</a>
      {% endif %}

      {% if user.role == 'admin' and not case.is_virtual %}
        <form method="post" action="{{ url_for('delete_case', case_code=case.case_code) }}">
          <button class="btn btn-outline-danger" onclick="return confirm('Delete/Archive this case? Case must be empty.')">Delete Case</button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

<div class="my-3"></div>

<div class="row g-3">
  <div class="col-12 col-lg-7">
    <div class="glass-soft p-3 p-md-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div class="fw-bold fs-5">Case Items</div>
        <div class="d-flex flex-column flex-md-row gap-2 align-items-start">
          <input id="filterBox" class="form-control" style="max-width: 420px;"
                 placeholder="Filter by UPC, type, or description…">
          <button class="btn btn-outline-light align-self-start" type="button" data-upc-scan-target="filterBox">
            Scan UPC
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0" id="invTable">
          <thead>
            <tr>
              <th style="width: 180px;">UPC</th>
              <th style="width: 120px;">Type</th>
              <th>Description</th>
              <th class="text-end" style="width: 90px;">Qty</th>
            </tr>
          </thead>
          <tbody>
            {% for i in items %}
            <tr>
              <td class="mono">{{ i.upc }}</td>
              <td>{{ i.item_type or "" }}</td>
              <td>{{ i.description or "" }}</td>
              <td class="text-end fw-bold">{{ i.qty }}</td>
            </tr>
            {% endfor %}
            {% if items|length == 0 %}
              <tr><td colspan="4" class="text-white-50">No inventory in this case.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="text-white-50 small mt-3">
        Bulk scans accept one UPC per line, or <span class="mono">UPC,qty</span>. Duplicate scans automatically add quantity.
      </div>
    </div>

    <div class="glass-soft p-3 p-md-4 mt-3">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div class="fw-bold fs-5">Reserve Items</div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead>
            <tr>
              <th style="width: 180px;">UPC</th>
              <th style="width: 120px;">Type</th>
              <th>Description</th>
              <th class="text-end" style="width: 90px;">Qty</th>
            </tr>
          </thead>
          <tbody>
            {% for i in reserve_items %}
            <tr>
              <td class="mono">{{ i.upc }}</td>
              <td>{{ i.item_type or "" }}</td>
              <td>{{ i.description or "" }}</td>
              <td class="text-end fw-bold">{{ i.qty }}</td>
            </tr>
            {% endfor %}
            {% if reserve_items|length == 0 %}
              <tr><td colspan="4" class="text-white-50">No inventory in reserve drawers.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="sticky-actions d-grid gap-3">

      <div class="glass p-3 p-md-4">
        <div class="fw-bold fs-5 mb-2">Move Case ↔ Reserve</div>
        <div class="text-white-50 mb-3">Shift items between the glass case and reserve drawers.</div>

        <form method="post" action="{{ url_for('transfer_case_location', case_code=case.case_code) }}" class="d-grid gap-2">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label text-white-50 mb-0">From</label>
              <select class="form-select" name="from_location" required>
                <option value="CASE">Case</option>
                <option value="RESERVE">Reserve</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label text-white-50 mb-0">To</label>
              <select class="form-select" name="to_location" required>
                <option value="RESERVE">Reserve</option>
                <option value="CASE">Case</option>
              </select>
            </div>
          </div>

          <label class="form-label text-white-50 mb-0 mt-2">UPCs to move</label>
          <div class="d-flex flex-column gap-2">
            <textarea class="form-control mono" id="case-transfer-upcs" name="upcs" rows="4" placeholder="Scan UPCs here…"></textarea>
            <button class="btn btn-outline-light align-self-start" type="button" data-upc-scan-target="case-transfer-upcs">
              Scan UPC
            </button>
          </div>

          <button class="btn btn-light">Move</button>
        </form>
      </div>

      <div class="glass-soft p-3 p-md-3 d-flex flex-wrap gap-2 justify-content-between align-items-center">
        <a class="btn btn-outline-light" href="{{ url_for('history', case_code=case.case_code) }}">Full Case History</a>
        <a class="btn btn-outline-light" href="{{ url_for('export_case', case_code=case.case_code) }}">Export CSV</a>
      </div>
    </div>
  </div>
</div>

<div class="my-4 divider"></div>

<div class="glass-soft p-3 p-md-4">
  <div class="fw-bold fs-5 mb-2">Recent Case History</div>
  <div class="text-white-50 mb-3">Latest 150 actions involving this case.</div>

  <div class="table-responsive">
    <table class="table table-sm table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>Time (UTC)</th>
          <th>User</th>
          <th>Action</th>
          <th>UPC</th>
          <th>Type</th>
          <th>Qty</th>
          <th>From → To</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for h in history %}
        <tr>
          <td class="text-white-50 small">{{ h.ts|local_ts }}</td>
          <td class="small">{{ h.username or "" }}</td>
          <td><span class="chip">{{ h.action }}</span></td>
          <td class="mono">{{ h.upc or "" }}</td>
          <td class="small">{{ h.item_type or "" }}</td>
          <td class="small">{{ h.qty or "" }}</td>
          <td class="small">{{ h.from_case_code or "" }}{% if h.from_case_code or h.to_case_code %} → {% endif %}{{ h.to_case_code or "" }}</td>
          <td class="small">{{ h.notes or "" }}</td>
        </tr>
        {% endfor %}
        {% if history|length == 0 %}
          <tr><td colspan="8" class="text-white-50">No history yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
  const filterBox = document.getElementById("filterBox");
  const table = document.getElementById("invTable");

  if (filterBox && table) {
    filterBox.addEventListener("input", () => {
      const q = filterBox.value.toLowerCase().trim();
      for (const row of table.tBodies[0].rows) {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(q) ? "" : "none";
      }
    });
  }
</script>

{% endblock %}
