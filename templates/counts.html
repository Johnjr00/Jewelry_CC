{% extends "base.html" %}
{% block content %}

<div class="glass p-3 p-md-4">
  <div class="d-flex flex-wrap align-items-start justify-content-between gap-2">
    <div>
      <div class="fw-bold fs-4">Daily Counts</div>
      <div class="text-white-50">Record today’s physical counts by case (Bracelet/Ring/Earring/Necklace/Other).</div>
      <div class="mt-2"><span class="chip">Date: <strong class="text-white">{{ today }}</strong></span></div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-light" href="{{ url_for('index') }}">Home</a>
    </div>
  </div>
</div>

<div class="my-3"></div>

<div class="row g-3">
  {% for c in cases %}
  {% set sys = sys_totals.get(c.case_code) %}
  {% set cc = counts_map.get(c.case_code) %}
  <div class="col-12 col-md-6 col-xl-4">
    <a href="{{ url_for('count_case', case_code=c.case_code) }}" class="text-decoration-none">
      <div class="case-tile">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="fw-bold">Case {{ c.case_code }}</div>
            <div class="text-white-50 small">{{ c.case_name }}</div>
            {% if c.is_virtual %}<div class="mt-1"><span class="chip">Virtual</span></div>{% endif %}
          </div>
          {% if cc %}
            <span class="chip">Counted</span>
          {% else %}
            <span class="chip">Not counted</span>
          {% endif %}
        </div>

        <div class="divider my-3"></div>

        <div class="d-flex flex-wrap gap-2">
          {% for cat in count_categories %}
            <span class="chip">Case {{ cat.short }}: <strong class="text-white">{{ sys.case[cat.count_key] }}</strong></span>
          {% endfor %}
          <span class="chip">Case Total: <strong class="text-white">{{ sys.case.total }}</strong></span>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-2">
          {% for cat in count_categories %}
            <span class="chip">Reserve {{ cat.short }}: <strong class="text-white">{{ sys.reserve[cat.count_key] }}</strong></span>
          {% endfor %}
          <span class="chip">Reserve Total: <strong class="text-white">{{ sys.reserve.total }}</strong></span>
          <span class="chip">Grand Total: <strong class="text-white">{{ sys.combined.total }}</strong></span>
        </div>

        {% if cc %}
          {% set ns = namespace(case_total=0, reserve_total=0) %}
          {% for cat in count_categories %}
            {% set ns.case_total = ns.case_total + cc[cat.count_key] %}
            {% set ns.reserve_total = ns.reserve_total + cc["reserve_" ~ cat.count_key] %}
          {% endfor %}
          <div class="mt-3 text-white-50 small">
            Case total: <span class="mono text-white">{{ ns.case_total }}</span>
            Reserve total: <span class="mono text-white">{{ ns.reserve_total }}</span>
            Grand total: <span class="mono text-white">{{ cc.total }}</span>
            {% if cc.username %} — {{ cc.username }}{% endif %}
            {% if cc.total != sys.combined.total %}
              <span class="ms-2 chip">Δ <strong class="text-white">{{ cc.total - sys.combined.total }}</strong></span>
            {% endif %}
          </div>
        {% else %}
          <div class="mt-3 text-white-50 small">Tap to enter today’s count.</div>
        {% endif %}
      </div>
    </a>
  </div>
  {% endfor %}
</div>

{% endblock %}
